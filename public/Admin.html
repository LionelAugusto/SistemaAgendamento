<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel do Sal√£o</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-pink-600 mb-6 text-center">Africa Hair Agendamentos</h1>
  <!-- üìå Formul√°rio de Agendamento Manual -->
<div class="bg-white p-4 rounded shadow mb-6 max-w-3xl mx-auto">
  <h2 class="text-xl font-bold text-gray-700 mb-4">Agendar Cliente Manualmente</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <input type="text" id="nome" placeholder="Nome do Cliente" class="border rounded px-3 py-2" />
    <input type="text" id="telefone" placeholder="Telefone" class="border rounded px-3 py-2" />
    <input type="text" id="servico" placeholder="Servi√ßo" class="border rounded px-3 py-2" />
    <input type="date" id="data" class="border rounded px-3 py-2" />
    <input type="time" id="hora" class="border rounded px-3 py-2" />
    <button onclick="agendarManual()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
      Agendar
    </button>
  </div>
</div>
  <div class="text-right mb-4">
  <button onclick="logout()" class="text-lg font-semibold text-red-800 underline px-4 py-2 hover:text-red-600">
  Sair
</button>

</div>

  <!-- Notifica√ß√£o visual -->
  <div id="notificacao" class="hidden bg-green-500 text-white text-center py-2 rounded mb-4">
    üì¢ Novo agendamento recebido!
  </div>

  <!-- üîç Filtro por data -->
  <div class="mb-6 flex items-center justify-center gap-4">
    <label for="filtroData" class="font-medium">Filtrar por data:</label>
    <input type="date" id="filtroData" class="border p-2 rounded" />
    <button onclick="filtrarAgendamentos()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded">
      Filtrar
    </button>
    <button onclick="limparFiltro()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
      Mostrar Todos
    </button>
  </div>

  <!-- üìã Tabela -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
      <thead class="bg-pink-600 text-white">
        <tr>
          <th class="py-3 px-4 text-left">Cliente</th>
          <th class="py-3 px-4 text-left">Telefone</th>
          <th class="py-3 px-4 text-left">Servi√ßo</th>
          <th class="py-3 px-4 text-left">Data</th>
          <th class="py-3 px-4 text-left">Hora</th>
          <th class="py-3 px-4 text-left">Status</th>
          <th class="py-3 px-4 text-left">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaAgendamentos" class="text-gray-700">
        <!-- Agendamentos ser√£o inseridos via JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- üìä Total de agendamentos -->
  <p id="totalAgendamentos" class="mt-4 text-center text-lg text-gray-700 font-semibold"></p>

 <script>
  let agendamentos = [];
  const tabela = document.getElementById("tabelaAgendamentos");
  const notificacao = document.getElementById("notificacao");
  const totalTexto = document.getElementById("totalAgendamentos");

  async function carregarAgendamentos() {
    try {
      const resposta = await fetch("http://localhost:3000/api/agendamentos");
      agendamentos = await resposta.json();
      exibirAgendamentos(agendamentos);
    } catch (erro) {
      console.error("Erro ao carregar agendamentos:", erro);
    }
  }

  function exibirAgendamentos(lista) {
    tabela.innerHTML = "";

    const ordenados = lista.sort((a, b) => {
      const dataHoraA = new Date(`${a.data}T${a.hora}`);
      const dataHoraB = new Date(`${b.data}T${b.hora}`);
      return dataHoraA - dataHoraB;
    });

    totalTexto.textContent = `üìÖ Total de agendamentos: ${ordenados.length}`;

    if (ordenados.length === 0) {
      tabela.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Nenhum agendamento encontrado.</td></tr>`;
      return;
    }

   ordenados.forEach(item => {
  const linha = document.createElement("tr");
  linha.innerHTML = `
    <td class="py-2 px-4">${item.nome}</td>
    <td class="py-2 px-4">${item.telefone}</td>
    <td class="py-2 px-4">${item.servico}</td>
    <td class="py-2 px-4">${item.data}</td>
    <td class="py-2 px-4">${item.hora}</td>
    <td class="py-2 px-4 ${corStatus(item.status)} font-semibold capitalize">${item.status}</td>
    <td class="py-2 px-4">
      ${item.status === "pendente" ? `<button onclick="marcarChegada('${item._id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">Chegou</button>` : ""}
      ${item.status !== "conclu√≠do" ? `<button onclick="marcarConcluido('${item._id}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded ml-2">Finalizado</button>` : ""}
    </td>
  `;
  tabela.appendChild(linha);
});

  }

  function corStatus(status) {
  switch (status) {
    case "pendente": return "text-red-600";
    case "presente": return "text-blue-600";
    case "conclu√≠do": return "text-green-600";
    default: return "";
  }
}


  function mostrarNotificacao() {
    notificacao.classList.remove("hidden");
    setTimeout(() => notificacao.classList.add("hidden"), 5000);
  }

  function logout() {
    localStorage.removeItem("logado");
    window.location.href = "login.html";
  }

  function filtrarAgendamentos() {
    const dataSelecionada = document.getElementById("filtroData").value;
    const filtrados = agendamentos.filter(a => a.data === dataSelecionada);
    exibirAgendamentos(filtrados);
  }

  function limparFiltro() {
    document.getElementById("filtroData").value = "";
    exibirAgendamentos(agendamentos);
  }

  async function marcarChegada(id) {
    try {
      await fetch(`http://localhost:3000/api/agendamentos/${id}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "presente" })
      });
      await carregarAgendamentos();
    } catch (erro) {
      console.error("Erro ao marcar chegada:", erro);
    }
  }

  async function marcarConcluido(id) {
    try {
      await fetch(`http://localhost:3000/api/agendamentos/${id}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "conclu√≠do" })
      });
      await carregarAgendamentos();
    } catch (erro) {
      console.error("Erro ao marcar como conclu√≠do:", erro);
    }
  }

  async function agendarManual() {
    const nome = document.getElementById("nome").value.trim();
    const telefone = document.getElementById("telefone").value.trim();
    const servico = document.getElementById("servico").value.trim();
    const data = document.getElementById("data").value;
    const hora = document.getElementById("hora").value;

    if (!nome || !telefone || !servico || !data || !hora) {
      alert("Preencha todos os campos para agendar.");
      return;
    }

    const novoAgendamento = { nome, telefone, servico, data, hora };

    try {
      const resposta = await fetch("http://localhost:3000/api/agendamentos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(novoAgendamento)
      });

      if (resposta.ok) {
        await carregarAgendamentos();
        mostrarNotificacao();
      } else {
        alert("Erro ao agendar.");
      }
    } catch (erro) {
      console.error("Erro ao agendar:", erro);
    }

    // Limpa os campos
    document.getElementById("nome").value = "";
    document.getElementById("telefone").value = "";
    document.getElementById("servico").value = "";
    document.getElementById("data").value = "";
    document.getElementById("hora").value = "";
  }

  // Iniciar carregamento autom√°tico
  window.onload = carregarAgendamentos;
</script>


</body>
</html>
